<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>☀️ SolarBrain AI Monitor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☀️</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background: #0e1117; color: white; padding: 40px; }
        .dashboard-container { max-width: 1200px; margin: auto; }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .price-selector { background: #161b22; padding: 10px 20px; border-radius: 8px; border: 1px solid #30363d; }
        select { background: #0e1117; color: #4ade80; border: 1px solid #4ade80; padding: 5px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: #161b22; padding: 20px; border-radius: 10px; border: 1px solid #30363d; text-align: center; transition: 0.3s; }
        .metric-label { color: #8b949e; font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; }
        .metric-value { font-size: 1.6rem; font-weight: bold; }
        .metric-subvalue { font-size: 0.9rem; margin-top: 4px; opacity: 0.8; }

        .actual-val { color: #FFA500; }
        .pred-val { color: #00F0FF; }
        .error-val { color: #eb4034; }
        .money-val { color: #4ade80; }

        .main-content { display: grid; grid-template-columns: 8fr 4fr; gap: 20px; margin-bottom: 30px; }
        .chart-box, .prediction-box { background: #161b22; padding: 25px; border-radius: 10px; border: 1px solid #30363d; }
        
        /* Prediction Form Style */
        .prediction-label { display: block; color: #8b949e; font-size: 0.75rem; margin-bottom: 5px; text-align: left; text-transform: uppercase; }
        .prediction-box input { background: #0e1117; color: white; border: 1px solid #30363d; padding: 10px; width: 100%; border-radius: 5px; margin-bottom: 15px; box-sizing: border-box; }
        .prediction-box button { background: #00F0FF; color: #0e1117; border: none; padding: 12px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .prediction-box button:hover { background: #00d7e6; }

        .logs-section { background: #161b22; padding: 20px; border-radius: 10px; border: 1px solid #30363d; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th { text-align: left; color: #8b949e; padding: 12px; border-bottom: 2px solid #30363d; }
        td { padding: 12px; border-bottom: 1px solid #21262d; }

        .status-healthy { border-top: 4px solid #4ade80; }
        .status-alert { border-top: 4px solid #eb4034; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(235, 64, 52, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(235, 64, 52, 0); } 100% { box-shadow: 0 0 0 0 rgba(235, 64, 52, 0); } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header-flex">
            <h1>☀️ SolarBrain Live: AI Analysis</h1>
            <div class="price-selector">
                <label style="color: #8b949e; font-size: 0.9rem;">kWh Price: </label>
                <select id="kwh-price" onchange="updateData()">
                    <option value="0.12">0.12 € (Low)</option>
                    <option value="0.18" selected>0.18 € (Mid)</option>
                    <option value="0.25">0.25 € (High)</option>
                    <option value="0.35">0.35 € (Peak)</option>
                </select>
            </div>
        </div>
        
        <div class="metrics-grid">
            <div id="card-actual" class="metric-card">
                <div class="metric-label">Actual Power</div>
                <div id="metric-actual" class="metric-value actual-val">0.00 W</div>
                <div id="system-status" class="metric-subvalue">Checking...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">AI Prediction</div>
                <div id="metric-pred" class="metric-value pred-val">0.00 W</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Error Gap</div>
                <div id="metric-abs-error" class="metric-value error-val">0.00 W</div>
                <div id="metric-percent-error" class="metric-subvalue error-val">0.0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Revenue Est.</div>
                <div id="metric-money" class="metric-value money-val">0.00 €/h</div>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-box">
                <canvas id="solarChart"></canvas>
            </div>
            <div class="prediction-box">
                <h3 style="margin-top:0">AI Strategy Simulator</h3>
                <p style="font-size: 0.8rem; color: #8b949e; margin-bottom: 20px;">Test custom weather scenarios against the AI model</p>
                
                <label class="prediction-label">Ambient Temperature</label>
                <input type="number" id="manual-temp" placeholder="Enter Temp in °C" value="25">
                
                <label class="prediction-label">Solar Irradiation</label>
                <input type="number" id="manual-irr" placeholder="Enter Irradiation in W/m²" value="800">
                
                <button onclick="runManualPrediction()">Run Simulation</button>
                <div id="manual-output" style="margin-top: 20px; text-align: center; font-weight: bold; color: #00F0FF; min-height: 1.2em;"></div>
            </div>
        </div>

        <div class="logs-section">
            <h3 style="margin-top:0">Recent Logs (Database Sync)</h3>
            <table id="logs-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Irradiance</th>
                        <th>Temp</th>
                        <th>Actual (W)</th>
                        <th>AI Pred (W)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <p id="status" style="text-align: center; color: #8b949e; margin-top: 20px; font-size: 0.8rem;">Connecting to API...</p>
    </div>

    <script>
        const ctx = document.getElementById('solarChart').getContext('2d');
        const solarChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Actual Power', data: [], borderColor: '#FFA500', borderWidth: 3, tension: 0.3, fill: false, pointRadius: 2 },
                    { label: 'AI Prediction', data: [], borderColor: '#00F0FF', borderWidth: 2, borderDash: [5, 5], tension: 0.3, fill: false, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
                    x: { grid: { display: false }, ticks: { color: '#8b949e' } }
                },
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });

        async function updateData() {
            try {
                const resLatest = await fetch('http://127.0.0.1:8000/latest');
                const latest = await resLatest.json();

                const resHistory = await fetch('http://127.0.0.1:8000/data');
                const history = await resHistory.json();

                if (latest.error) return;

                const KWH_PRICE = parseFloat(document.getElementById('kwh-price').value);
                const absError = Math.abs(latest.power - latest.api_predicted_power);
                const errorP = latest.power > 0 ? (absError / latest.power * 100) : 0;
                const revenue = (latest.power / 1000) * KWH_PRICE;

                document.getElementById('metric-actual').innerText = `${latest.power.toFixed(2)} W`;
                document.getElementById('metric-pred').innerText = `${latest.api_predicted_power.toFixed(2)} W`;
                document.getElementById('metric-abs-error').innerText = `${absError.toFixed(2)} W`;
                document.getElementById('metric-percent-error').innerText = `(${errorP.toFixed(1)}%)`;
                document.getElementById('metric-money').innerText = `${revenue.toFixed(3)} €/h`;
                document.getElementById('system-status').innerText = latest.status;

                const actualCard = document.getElementById('card-actual');
                actualCard.className = latest.is_alert ? "metric-card status-alert" : "metric-card status-healthy";
                document.getElementById('system-status').style.color = latest.is_alert ? "#eb4034" : "#4ade80";

                const reversedData = [...history].reverse();
                solarChart.data.labels = reversedData.map(d => d.id);
                solarChart.data.datasets[0].data = reversedData.map(d => d.power);
                solarChart.data.datasets[1].data = reversedData.map(d => d.api_predicted_power);
                solarChart.update('none');

                const tbody = document.querySelector('#logs-table tbody');
                tbody.innerHTML = history.slice(0, 5).map(row => `
                    <tr>
                        <td>#${row.id}</td>
                        <td>${row.irradiance.toFixed(2)}</td>
                        <td>${row.temperature.toFixed(1)}°C</td>
                        <td class="actual-val">${row.power.toFixed(1)}</td>
                        <td class="pred-val">${row.api_predicted_power.toFixed(1)}</td>
                        <td style="color: ${row.power < (row.api_predicted_power * 0.8) ? '#eb4034' : '#4ade80'}">
                            ${row.power < (row.api_predicted_power * 0.8) ? '⚠ Alert' : '✓ Healthy'}
                        </td>
                    </tr>
                `).join('');

                document.getElementById('status').innerText = `Last Sync: ${new Date().toLocaleTimeString()}`;
            } catch (e) { 
                document.getElementById('status').innerText = "API Offline - Check Backend Server";
            }
        }

        async function runManualPrediction() {
            const temp = document.getElementById('manual-temp').value;
            const irr = document.getElementById('manual-irr').value;
            const output = document.getElementById('manual-output');
            
            output.innerText = "Calculating scenario...";
            
            const formData = new FormData();
            formData.append('temp', temp);
            formData.append('irr', irr);

            try {
                const res = await fetch('http://127.0.0.1:8000/predict', { method: 'POST', body: formData });
                const data = await res.json();
                output.innerText = `AI Forecast: ${data.predicted_power} Watts`;
            } catch (e) {
                output.innerText = "Error: API connection failed";
            }
        }

        setInterval(updateData, 3000);
        updateData();
    </script>
</body>
</html>